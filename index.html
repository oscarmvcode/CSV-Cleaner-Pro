<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>CSV Cleaner Pro</title>
  
  <link rel="stylesheet" href="./libs/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" 
      integrity="sha384-QuGBSgV5Im3DzL2z+8Ko9/hqNy/N0O7zwvXAtfd1MvPKWa/UbeLV65cfm4BV5Wgq" 
      crossorigin="anonymous">
  <link rel="stylesheet" href="./css/styles.css">
  <link rel="manifest" href="./manifest.json">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary mb-4 shadow-sm">
  <div class="container">
    <span class="navbar-brand mb-0 h1"><i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV Cleaner Pro</span>
  </div>
</nav>

<div class="container pb-5">
  
  <div id="dropZone" class="drop-zone border border-primary border-2 border-dashed rounded-3 p-5 text-center bg-white mb-4">
    <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
    <p class="fs-5 mt-2">Arrastra aquí tu archivo CSV / TXT / TSV</p>
    <small class="text-muted">Los datos se procesan localmente en tu navegador</small>
  </div>

  <div class="row">
  <div class="col-12">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white py-3">
        <h5 class="card-title mb-0 text-primary fw-bold">Opciones de limpieza</h5>
      </div>
      <div class="card-body">
        <div class="row g-3" id="checklistContainer">
          
          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="remove-empty-rows" id="check1" checked>
              <label class="form-check-label" for="check1">Eliminar filas vacías</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="normalize-headers" id="check2" checked>
              <label class="form-check-label" for="check2">Normalizar encabezados</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="normalize-nulls" id="check3" checked>
              <label class="form-check-label" for="check3">Normalizar valores nulos</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="normalize-dates" id="check5" checked>
              <label class="form-check-label" for="check5">Normalizar fechas</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="normalize-numbers" id="check_num" checked>
              <label class="form-check-label" for="check_num">Normalizar números (Ingresos)</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="capitalize-text" id="check6" checked>
              <label class="form-check-label" for="check6">Capitalizar Nombres/Ciudades</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="validate-emails" id="check7" checked>
              <label class="form-check-label" for="check7">Validar Formato de Emails</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="normalize-booleans" id="check8" checked>
              <label class="form-check-label" for="check8">Normalizar Si/No (Activo)</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="remove-invalid-rows" id="check9" checked>
              <label class="form-check-label" for="check9">Eliminar filas inválidas (Edad -5)</label>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" data-cleaner="remove-duplicates" id="check4" checked>
              <label class="form-check-label" for="check4">Eliminar duplicados</label>
            </div>
          </div>

        </div> </div>
    </div>
  </div>
</div>

          <hr class="my-4">

          <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
            <div id="fileStatus" class="badge bg-secondary p-2 fs-6">
              <i class="bi bi-info-circle me-1"></i> Ningún archivo cargado
            </div>
            <div class="d-flex gap-2 w-100 w-md-auto">
              <button id="cleanBtn" class="btn btn-primary flex-grow-1">
                <i class="bi bi-magic me-1"></i> Limpiar CSV
              </button>
              <button id="exportBtn" class="btn btn-success flex-grow-1">
                <i class="bi bi-download me-1"></i> Descargar
              </button>
              <button id="installPWA" class="btn btn-success shadow-sm" style="display: none;">
            <i class="bi bi-download me-2"></i>Instalar App
            </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="messageBox" class="alert alert-info hidden mb-4" role="alert"></div>

  <div class="card shadow-sm overflow-hidden">
    <div class="table-responsive">
      <div id="table"></div> </div>
  </div>

</div>

<input type="file" id="csvInput" accept=".csv,.txt,.tsv,.dat" hidden>

<div id="overlay" class="overlay hidden position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-75 z-3">
  <div class="text-center text-white bg-dark p-4 rounded-3 shadow">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <p id="overlayText" class="h5 mb-3">Limpiando datos…</p>
    <div class="progress mb-2" style="height: 10px; width: 250px;">
      <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%"></div>
    </div>
    <small id="progressStep" class="text-light opacity-75"></small>
  </div>
</div>
<button type="button" class="btn btn-info shadow-lg rounded-circle position-fixed bottom-0 end-0 m-4 z-3" 
        style="width: 60px; height: 60px;" data-bs-toggle="modal" data-bs-target="#userManualModal">
  <i class="bi bi-question-lg fs-3 text-white"></i>
</button>

<div class="modal fade" id="userManualModal" tabindex="-1" aria-labelledby="manualTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="manualTitle"><i class="bi bi-book me-2"></i>Manual de Usuario - CSV Cleaner Pro</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <section class="mb-4">
            <h6 class="fw-bold text-primary"><i class="bi bi-1-circle me-2"></i>Carga de Datos</h6>
            <p>Arrastra tu archivo al recuadro azul o haz clic para buscarlo. Aceptamos archivos <code>.csv</code>, <code>.txt</code> y <code>.tsv</code>.</p>
          </section>

          <section class="mb-4">
            <h6 class="fw-bold text-primary"><i class="bi bi-2-circle me-2"></i>Configuración de Limpieza</h6>
            <ul class="list-group list-group-flush">
  <li class="list-group-item small">
    <i class="bi bi-trash3-fill text-danger me-2"></i>
    <b>Eliminar filas vacías:</b> Borra registros que no contienen datos reales.
  </li>
  <li class="list-group-item small">
    <i class="bi bi-layers-half text-warning me-2"></i>
    <b>Eliminar duplicados:</b> Detecta filas idénticas y deja solo una.
  </li>
  <li class="list-group-item small">
    <i class="bi bi-magic text-primary me-2"></i>
    <b>Normalizar nulos:</b> Cambia espacios vacíos por etiquetas <span class="badge text-bg-light border text-muted">NULL</span>.
  </li>
  <li class="list-group-item small">
    <i class="bi bi-calendar-check text-success me-2"></i>
    <b>Normalizar fechas:</b> Ajusta diversos formatos de fecha a un estándar único (AAAA-MM-DD).
  </li>
  <li class="list-group-item small">
    <i class="bi bi-type-h1 text-info me-2"></i>
    <b>Limpiar encabezados:</b> Remueve espacios innecesarios y caracteres especiales de los títulos.
  </li>
  <li class="list-group-item small">
    <i class="bi bi-exclamation-triangle text-secondary me-2"></i>
    <b>Detectar Outliers:</b> Identifica valores numéricos que se desvían drásticamente del promedio.
  </li>
</ul>
          </section>

          <section class="mb-4">
            <h6 class="fw-bold text-primary"><i class="bi bi-3-circle me-2"></i>Navegación y Exportación</h6>
            <p>La tabla muestra <b>50 filas por página</b> para mejorar la velocidad. Usa los botones "Anterior" y "Siguiente" al final de la tabla. Una vez conforme, pulsa <b>Descargar</b> para obtener el archivo completo.</p>
          </section>

          <div class="alert alert-secondary d-flex align-items-center" role="alert">
            <i class="bi bi-shield-lock-fill me-2 fs-4"></i>
            <div class="small">Sus datos nunca salen de su navegador. El procesamiento es 100% local y privado.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>
<script>
  //  REGISTRO CON ACTUALIZACIÓN AUTOMÁTICA
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").then(reg => {
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Si hay código nuevo en GitHub, forzamos la actualización
              newWorker.postMessage('SKIP_WAITING');
            }
          });
        });
      });
    });

    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!refreshing) {
        window.location.reload(); // La página se refresca sola al detectar cambios
        refreshing = true;
      }
    });
  }

  // BOTÓN DE INSTALACIÓN
  let deferredPrompt;
  const installBtn = document.getElementById('installPWA');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (installBtn) installBtn.style.display = 'block';
  });

  if (installBtn) {
    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });
  }

  // Ocultar si ya se instaló o ya está abierta como App
  window.addEventListener('appinstalled', () => {
    if (installBtn) installBtn.style.display = 'none';
  });

  if (window.matchMedia('(display-mode: standalone)').matches) {
    if (installBtn) installBtn.style.display = 'none';
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="./libs/papaparse.min.js"></script>
<script type="module" src="js/core/App.js"></script>
</body>
</html>